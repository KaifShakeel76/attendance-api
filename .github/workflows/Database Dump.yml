name: Sync Database Dump to GCP Bucket

on:
  workflow_dispatch:
    inputs:
      instance_name:
        description: 'Name of the GCP instance'
        required: true
      bucket_name:
        description: 'GCP bucket name'
        required: true
      dump_file_path:
        description: 'Path to the directory containing the .sql files'
        required: true

jobs:
  sync-dump:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'
        service_account_key: ${{ secrets.GCP_SA_DB_KEY }}
        export_default_credentials: true

    - name: Find and upload .sql files to GCP bucket
      run: |
        sql_files=$(find ${{ github.event.inputs.dump_file_path }} -name "*.sql")
        for file in $sql_files; do
          echo "Uploading $file to gs://${{ github.event.inputs.bucket_name }}/"
          gsutil cp "$file" gs://${{ github.event.inputs.bucket_name }}/
        done
